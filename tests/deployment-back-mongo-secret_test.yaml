suite: test deployment
templates:
  - deployment-back.yaml
tests:
  - it: should reference created secret
    release:
      namespace: default
    set:
      services.webapp.host: myapp.example.com
      services.api.host: myapi.example.com
      services.files.host: myfiles.example.com
      domain: .example.com
      ingress.enabled: false
      mongodb.usePassword: true
      mongodb.mongodbUsername: myuser
      mongodb.mongodbPassword: mypassword
      neoload.configuration.backend.mongo.host: mymongo.example.com
      neoload.configuration.backend.mongo.port: 27017
    asserts:
      - isKind:
          of: Deployment
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MONGODB_LOGIN
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-nlweb-mongo-secret
                key: username
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MONGODB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-nlweb-mongo-secret
                key: password
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MONGODB_HOST
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-nlweb-mongo-secret
                key: host
          any: true
  - it: should reference provided existing secret
    release:
      namespace: default
    set:
      services.webapp.host: myapp.example.com
      services.api.host: myapi.example.com
      services.files.host: myfiles.example.com
      domain: .example.com
      ingress.enabled: false
      mongodb.usePassword: true
      mongodb.existingSecret: my-existing-secret
      neoload.configuration.backend.mongo.port: 27017
    asserts:
      - isKind:
          of: Deployment
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MONGODB_LOGIN
            valueFrom:
              secretKeyRef:
                name: my-existing-secret
                key: username
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MONGODB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: my-existing-secret
                key: password
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MONGODB_HOST
            valueFrom:
              secretKeyRef:
                name: my-existing-secret
                key: host
          any: true
  - it: should prioritize existing secret when both existing and login/password are configured
    release:
      namespace: default
    set:
      services.webapp.host: myapp.example.com
      services.api.host: myapi.example.com
      services.files.host: myfiles.example.com
      domain: .example.com
      ingress.enabled: false
      mongodb.usePassword: true
      mongodb.existingSecret: my-existing-secret
      mongodb.mongodbUsername: myuser
      mongodb.mongodbPassword: mypassword
      neoload.configuration.backend.mongo.host: mymongo.example.com
      neoload.configuration.backend.mongo.port: 27017
    asserts:
      - isKind:
          of: Deployment
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MONGODB_LOGIN
            valueFrom:
              secretKeyRef:
                name: my-existing-secret
                key: username
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MONGODB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: my-existing-secret
                key: password
          any: true
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: MONGODB_HOST
            valueFrom:
              secretKeyRef:
                name: my-existing-secret
                key: host
          any: true