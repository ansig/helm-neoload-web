suite: test deployment
templates:
  - deployment-back.yaml
tests:
  - it: should reference created secret
    release:
      namespace: default
    set:
      services.webapp.host: myapp.example.com
      services.api.host: myapi.example.com
      services.files.host: myfiles.example.com
      domain: .example.com
      ingress.enabled: false
      neoload.configuration.backend.mongo.host: mymongo.example.com
      neoload.configuration.backend.mongo.port: 27017
      neoload.configuration.secretKey: mysecretkey
    asserts:
      - isKind:
          of: Deployment
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NLWEB_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-nlweb-key-secret
                key: nlwSecretKey
          any: true
  - it: should reference existing secret
    release:
      namespace: default
    set:
      services.webapp.host: myapp.example.com
      services.api.host: myapi.example.com
      services.files.host: myfiles.example.com
      domain: .example.com
      ingress.enabled: false
      neoload.configuration.backend.mongo.host: mymongo.example.com
      neoload.configuration.backend.mongo.port: 27017
      neoload.configuration.secretKeyExistingSecret: my-secret
    asserts:
      - isKind:
          of: Deployment
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NLWEB_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: my-secret
                key: nlwSecretKey
          any: true
  - it: should prefer existing secret over created one when both provided
    release:
      namespace: default
    set:
      services.webapp.host: myapp.example.com
      services.api.host: myapi.example.com
      services.files.host: myfiles.example.com
      domain: .example.com
      ingress.enabled: false
      neoload.configuration.backend.mongo.host: mymongo.example.com
      neoload.configuration.backend.mongo.port: 27017
      neoload.configuration.secretKeyExistingSecret: my-secret
      neoload.configuration.secretKey: mysecretkey
    asserts:
      - isKind:
          of: Deployment
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NLWEB_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: my-secret
                key: nlwSecretKey
          any: true
